###########################################################################################################################
#Import data and prepare for analysis
###########################################################################################################################
#import data
  #run tidy_data: This script imports and tidies the raw file containing phenotypes and 
  #imports the matrix of beta values following preprocessing
  #these objects are called "SABRE_normalisedbetas" and "samplepheno"


###########################################################################################################################
#Create dataframe of Illig data (supplementary table 2) http://www.ncbi.nlm.nih.gov/pubmed/23691101
###########################################################################################################################


# CpG sites associated with smoking in Illig paper 
cpgs <- c("cg09469355",   "cg08884752", 	"cg12547807", 	"cg04885881", 	"cg21393163", 	"cg21913886", 	"cg19713429", 	"cg27537125", 	"cg15542713", 	"cg24049493", 	"cg23090529", 	"cg21140898", 	"cg19406367", 	"cg25189904", 	"cg09662411", 	"cg18146737", 	"cg12876356", 	"cg18316974", 	"cg09935388", 	"cg11231349", 	"cg08709672", 	"cg20295214", 	"cg03547355", 	"cg17819085", 	"cg23079012", 	"cg06635952", 	"cg26271591", 	"cg23667432", 	"cg03188382", 	"cg19713851", 	"cg27241845", 	"cg03329539", 	"cg06644428", 	"cg05951221", 	"cg21566642", 	"cg01940273", 	"cg13193840", 	"cg17024919", 	"cg15693572", 	"cg23480021", 	"cg03274391", 	"cg00501876", 	"cg18642234", 	"cg15417641", 	"cg00336149", 	"cg21188533", 	"cg19859270", 	"cg02657160", 	"cg25197194", 	"cg08202836", 	"cg21121843", 	"cg19719391", 	"cg24556382", 	"cg11554391", 	"cg17924476", 	"cg08606254", 	"cg12806681", 	"cg03991871", 	"cg23916896", 	"cg11902777", 	"cg01899089", 	"cg05575921", 	"cg26703534", 	"cg01097768", 	"cg14817490", 	"cg25648203", 	"cg21161138", 	"cg03604011", 	"cg24090911", 	"cg13039251", 	"cg05673882", 	"cg26908328", 	"cg16786458", 	"cg14580211", 	"cg12513616", 	"cg01882991", 	"cg06126421", 	"cg14753356", 	"cg24859433", 	"cg15342087", 	"cg17619755", 	"cg10807309", 	"cg15474579", 	"cg00931843", 	"cg00921574", 	"cg19717773", 	"cg02451831", 	"cg08972170", 	"cg19089201", 	"cg22132788", 	"cg04180046", 	"cg12803068", 	"cg07826859", 	"cg03440944", 	"cg21322436", 	"cg25949550", 	"cg11207515", 	"cg17372101", 	"cg12276019", 	"cg24540678", 	"cg13518625", 	"cg19589396", 	"cg25305703", 	"cg12075928", 	"cg26361535", 	"cg13787850", 	"cg01692968", 	"cg13910681", 	"cg22539182", 	"cg25953130", 	"cg27312979", 	"cg25421530", 	"cg01744331", 	"cg07123182", 	"cg16556677", 	"cg26963277", 	"cg04039799", 	"cg09197783", 	"cg16611234", 	"cg19254163", 	"cg21611682", 	"cg14624207", 	"cg01901332", 	"cg11660018", 	"cg23771366", 	"cg03234777", 	"cg26282236", 	"cg02583484", 	"cg04158018", 	"cg23681440", 	"cg23126342", 	"cg25491122", 	"cg06885459", 	"cg17487894", 	"cg01731783", 	"cg22851561", 	"cg24996979", 	"cg10919522", 	"cg13976502", 	"cg13038618", 	"cg05875421", 	"cg05284742", 	"cg06819357", 	"cg26242531", 	"cg11730703", 	"cg01208318", 	"cg15022400", 	"cg03489965", 	"cg18335991", 	"cg00310412", 	"cg11152412", 	"cg23161492", 	"cg05194346", 	"cg01207684", 	"cg09099830", 	"cg03155159", 	"cg00911794", 	"cg23621097", 	"cg09858022", 	"cg19572487", 	"cg04956244", 	"cg16255816", 	"cg03373393", 	"cg25809905", 	"cg21280392", 	"cg07465627", 	"cg02186444", 	"cg07251887", 	"cg06459104", 	"cg00073090", 	"cg15187398", 	"cg07381806", 	"cg00835193", 	"cg03636183", 	"cg15159987", 	"cg23973524", 	"cg11902728", 	"cg22649124", 	"cg11701312", 	"cg16201146", 	"cg07339236", 	"cg00871610", 	"cg06595162", 	"cg23110422", 	"cg22635096", 	"cg02532700", 	"cg01127300"
) 

##############

#Get reference data : use median methylation value of never smokers (get average from discovery and replication cohorts F3 and F4)
reference_never_median_beta_discovery<- c(0.3299,  0.6803,  0.1885,	0.3115,	0.0445,	0.8917,	0.0987,	0.0877,	0.4002,	0.1219,	0.2061,	0.3534,	0.8147,	0.2740,	0.4805,	0.9565,	0.5475,	0.9544,	0.5765,	0.8372,	0.6776,	0.8467,	0.6024,	0.7041,	0.9594,	0.1388,	0.2569,	0.3401,	0.2432,	0.4950,	0.4617,	0.1598,	0.2142,	0.2199,	0.5658,	0.3437,	0.1525,	0.1708,	0.2942,	0.4259,	0.3190,	0.3692,	0.2316,	0.6818,	0.2530,	0.5724,	0.9560,	0.9255,	0.4321,	0.8802,	0.1334,	0.5305,	0.7934,	0.0911,	0.2628,	0.9490,	0.9537,	0.9469,	0.1286,	0.0379,	0.2486,	0.8841,	0.6269,	0.7457,	0.1350,	0.8642,	0.6998,	0.0759,	0.8246,	0.7536,	0.1515,	0.0824,	0.1744,	0.6909,	0.2101,	0.6357,	0.7724,	0.2383,	0.9322,	0.9371,	0.6519,	0.1534,	0.3563,	0.2963,	0.1005,	0.7015,	0.8243,	0.5272,	0.9094,	0.8599,	0.2316,	0.7382,	0.5836,	0.7533,	0.2855,	0.0852,	0.2725,	0.3192,	0.1235,	0.0855,	0.0565,	0.7511,	0.7103,	0.4672,	0.7593,	0.2680,	0.1619,	0.0782,	0.1902,	0.4928,	0.5558,	0.8762,	0.9380,	0.9527,	0.8507,	0.9013,	0.1954,	0.7554,	0.1449,	0.5778,	0.5276,	0.4747,	0.6741,	0.2926,	0.1993,	0.0561,	0.5699,	0.1476,	0.1587,	0.2499,	0.5136,	0.9053,	0.3917,	0.4107,	0.6572,	0.4718,	0.0802,	0.1323,	0.2701,	0.4082,	0.0755,	0.7424,	0.6637,	0.2288,	0.7804,	0.2836,	0.0804,	0.2217,	0.6581,	0.2994,	0.0522,	0.1212,	0.3928,	0.7670,	0.5947,	0.3190,	0.2870,	0.2768,	0.3923,	0.4477,	0.5979,	0.1406,	0.0849,	0.5129,	0.2667,	0.1802,	0.5410,	0.3329,	0.2918,	0.1727,	0.2507,	0.4132,	0.8822,	0.4930,	0.6339,	0.3062,	0.3524,	0.1161,	0.3002,	0.6390,	0.0828,	0.5267,	0.8358,	0.9005,	0.2511,	0.0924,	0.4576
)
reference_never_median_beta_replication<- c(0.3021,  0.5889,	0.1623,	0.2899,	0.0572,	0.8314,	0.0961,	0.0840,	0.3784,	0.1112,	0.1670,	0.3454,	0.6663,	0.2856,	0.5557,	0.9374,	0.7010,	0.9496,	0.4757,	0.8281,	0.6442,	0.7816,	0.5325,	0.6214,	0.9578,	0.1239,	0.2535,	0.3272,	0.2194,	0.4462,	0.4457,	0.1558,	0.1147,	0.1757,	0.5511,	0.2941,	0.1388,	0.1593,	0.3159,	0.4266,	0.2872,	0.4298,	0.2206,	0.6019,	0.2315,	0.5309,	0.9502,	0.9111,	0.4084,	0.8700,	0.1209,	0.4848,	0.7247,	0.0765,	0.2556,	0.9440,	0.9459,	0.9175,	0.1158,	0.0410,	0.2381,	0.9028,	0.6180,	0.6593,	0.1327,	0.8473,	0.7304,	0.0681,	0.7998,	0.7054,	0.1427,	0.0783,	0.1752,	0.6447,	0.1823,	0.6087,	0.6919,	0.2451,	0.8774,	0.9067,	0.6169,	0.1440,	0.2999,	0.3293,	0.0767,	0.6278,	0.7564,	0.4908,	0.8742,	0.8727,	0.1987,	0.7014,	0.5631,	0.6934,	0.2849,	0.0840,	0.2166,	0.3247,	0.0974,	0.0856,	0.0567,	0.6884,	0.6679,	0.4791,	0.7442,	0.2767,	0.1370,	0.0737,	0.1757,	0.4823,	0.5413,	0.8117,	0.9294,	0.9479,	0.8239,	0.9110,	0.1845,	0.6918,	0.1228,	0.5264,	0.4844,	0.4327,	0.6406,	0.2608,	0.1859,	0.0626,	0.4957,	0.1380,	0.1395,	0.2537,	0.4865,	0.8605,	0.3839,	0.3790,	0.6395,	0.4375,	0.0813,	0.1256,	0.3003,	0.4037,	0.0665,	0.6985,	0.5934,	0.2211,	0.8144,	0.2246,	0.0842,	0.2349,	0.5936,	0.2711,	0.0633,	0.1142,	0.4374,	0.7476,	0.6128,	0.3001,	0.2034,	0.1906,	0.3709,	0.4502,	0.5706,	0.1392,	0.0763,	0.5170,	0.2527,	0.1617,	0.5200,	0.3216,	0.2842,	0.1440,	0.2113,	0.3898,	0.8938,	0.5152,	0.6090,	0.2886,	0.3680,	0.1012,	0.2918,	0.5935,	0.0707,	0.4496,	0.7731,	0.8547,	0.2046,	0.1014,	0.4485
)

#bind to form a dataframe
Illig_data<- as.data.frame(cbind(reference_never_median_beta_discovery,reference_never_median_beta_replication ))
Illig_data<- cbind(cpgs, Illig_data)
Illig_data$cpgs<- as.character(Illig_data$cpgs)

rm(reference_never_median_beta_discovery, reference_never_median_beta_replication)

#get average of reference data
Illig_data$reference_never_median_beta_all <- (Illig_data$reference_never_median_beta_discovery + Illig_data$reference_never_median_beta_replication)/2

###############

#get effect size data- find mean effect size per CpG (as methylation betas) by importing data from Illig table
discovery_effect<- c(-1.7622,   -4.0125,   -2.1385,   -7.4143, 	-0.69344, 	-3.3794, 	-0.44637, 	-1.21415, 	9.5242, 	4.0531, 	-2.2774, 	-3.2754, 	3.1142, 	-8.1918, 	-3.73, 	-1.5456, 	-8.47810000000001, 	-1.863, 	-15.309, 	-1.92, 	-2.5825, 	-2.9844, 	-2.75799999999999, 	-2.301, 	-1.1011, 	1.9969, 	-5.5731, 	-1.5705, 	-1.1947, 	-6.4717, 	-8.7388, 	-2.392, 	-7.0508, 	-5.2066, 	-16.6965, 	-7.888, 	-2.4077, 	-3.094, 	10.8674, 	18.6272, 	18.0645, 	-4.4316, 	-1.6179, 	7.91590000000001, 	6.4587, 	10.1755, 	-1.30749999999999, 	-1.4812, 	4.6228, 	1.5089, 	-2.0675, 	4.1802, 	-4.2454, 	-1.03248, 	5.8036, 	0.703299999999996, 	-2.4357, 	-5.73399999999999, 	-2.1082, 	-1.11996, 	-2.8583, 	-24.3991, 	-6.169, 	-2.40199999999999, 	-3.81225, 	-7.9626, 	-10.4479, 	3.39587, 	-4.0817, 	7.1504, 	-2.6538, 	-0.59522, 	2.1641, 	-3.90900000000001, 	-0.873000000000002, 	-1.39859999999999, 	-17.0529, 	-5.3664, 	-4.02899999999999, 	-3.35719999999999, 	4.05019999999999, 	1.8323, 	-3.232, 	6.3705, 	-0.450550000000001, 	-4.0493, 	-2.30229999999999, 	5.32899999999999, 	1.8564, 	6.6794, 	2.1692, 	14.9598, 	-5.1247, 	-2.42479999999999, 	-4.7443, 	-1.37529, 	8.2753, 	7.2277, 	-0.7689, 	-0.677029999999999, 	-0.49416, 	-3.86030000000001, 	-6.04889999999999, 	-7.8, 	-5.53600000000001, 	-3.0977, 	-1.4187, 	-0.414310000000001, 	1.4125, 	-4.6863, 	5.02359999999999, 	1.5969, 	-1.2068, 	-0.912999999999997, 	-3.8405, 	-2.8628, 	-1.6233, 	-3.04289999999999, 	-1.2548, 	-3.8772, 	-5.2424, 	-5.1484, 	-5.066, 	-3.8747, 	-2.2552, 	-0.69317, 	2.457, 	-2.0898, 	-1.2475, 	-1.3088, 	9.11000000000001, 	2.361, 	4.8836, 	2.80069999999999, 	-2.0523, 	-6.0595, 	-0.558449999999999, 	-0.8884, 	-1.0101, 	-4.4855, 	-0.52389, 	-3.7647, 	5.6982, 	4.0245, 	2.06419999999999, 	-7.7353, 	-0.732820000000001, 	2.6597, 	-3.9404, 	-1.9653, 	-0.304740000000001, 	-1.5956, 	9.9753, 	-1.8306, 	-1.72129999999999, 	-1.1892, 	4.6004, 	3.4679, 	1.2032, 	-10.0183, 	2.4992, 	-0.572700000000001, 	-0.34346, 	6.5291, 	2.3682, 	-1.3756, 	3.82, 	-5.1337, 	-5.4507, 	-0.262799999999999, 	-2.7521, 	-5.1181, 	-8.22849999999999, 	-14.7441, 	-3.53380000000001, 	4.2136, 	5.756, 	-0.710699999999999, 	-1.4144, 	-3.5737, 	-1.10312, 	-4.3308, 	-2.7056, 	-3.6816, 	3.3599, 	-1.15296, 	-3.8336
)
replication_effect<- c(-1.6099,   -2.81979999999999, 	-1.4614, 	-6.7149, 	-0.68405, 	-3.5057, 	-0.49342, 	-0.73492, 	9.9507, 	3.8345, 	-1.6371, 	-2.6235, 	4.5365, 	-7.3991, 	-9.49309999999999, 	-2.8745, 	-22.6313, 	-1.7279, 	-16.4712, 	-3.3428, 	-2.44439999999999, 	-4.36479999999999, 	-2.2104, 	-1.98120000000001, 	-0.96440000000001, 	1.3837, 	-4.7982, 	-1.4564, 	-1.1502, 	-4.4502, 	-8.3635, 	-2.5729, 	-3.75382, 	-4.528, 	-15.5755, 	-7.5282, 	-1.9091, 	-2.468, 	6.9033, 	15.7704, 	11.9284, 	-3.1183, 	-1.1142, 	5.2791, 	3.7103, 	5.55690000000001, 	-1.9446, 	-1.3694, 	4.8759, 	1.853, 	-1.3157, 	3.1426, 	-4.8709, 	-0.687099999999999, 	3.2526, 	0.693599999999994, 	-2.4193, 	-7.87749999999999, 	-1.94492, 	-0.94659, 	-2.2615, 	-23.2905, 	-5.765, 	-1.8888, 	-3.1682, 	-7.5465, 	-10.6031, 	1.93057, 	-4.2098, 	4.6683, 	-1.9902, 	-0.64671, 	1.5695, 	-4.612, 	-1.1957, 	-1.49279999999999, 	-17.8887, 	-6.4106, 	-4.92020000000001, 	-5.4226, 	2.62009999999999, 	2.0099, 	-2.1431, 	5.6581, 	-0.516119999999999, 	-4.11849999999999, 	-3.1008, 	4.94830000000001, 	2.87189999999999, 	5.02010000000001, 	2.095, 	15.1232, 	-3.7787, 	-1.42009999999999, 	-4.4589, 	-0.952359999999999, 	5.2891, 	4.09409999999999, 	-0.82503, 	-0.512169999999999, 	-0.70137, 	-1.83040000000001, 	-6.1682, 	-4.9707, 	-6.3504, 	-3.8308, 	-1.2104, 	-0.39709, 	0.9348, 	-5.413, 	3.85970000000001, 	2.7823, 	-1.3473, 	-0.812899999999994, 	-3.2855, 	-1.93449999999999, 	-0.744800000000001, 	-2.5682, 	-0.9808, 	-2.9197, 	-5.3765, 	-3.591, 	-4.335, 	-2.9625, 	-1.7865, 	-0.56123, 	3.6488, 	-1.7723, 	-1.2063, 	-2.6755, 	7.5574, 	2.4624, 	3.0119, 	2.6292, 	-1.6429, 	-3.596, 	-0.480170000000001, 	-0.610400000000001, 	-0.9629, 	-5.3384, 	-0.44131, 	-4.32, 	2.283, 	3.284, 	1.2263, 	-6.2008, 	-0.69752, 	2.4604, 	-2.9988, 	-2.6213, 	-0.33866, 	-1.52214, 	4.8933, 	-3.4185, 	-2.56569999999999, 	-2.719, 	1.9861, 	1.8342, 	1.042, 	-7.8054, 	1.5855, 	-0.899900000000001, 	-0.40104, 	3.8698, 	1.1379, 	-1.4603, 	3.008, 	-2.9392, 	-4.6963, 	-0.903500000000002, 	-1.765, 	-4.2724, 	-11.6612, 	-17.6258, 	-2.2744, 	2.1603, 	1.389, 	-0.54374, 	-1.1572, 	-3.54829999999999, 	-0.828230000000001, 	-3.8931, 	-2.288, 	-3.60010000000001, 	2.6395, 	-0.936690000000001, 	-3.8713
)
#take average
all_effect <- (discovery_effect + replication_effect)/2

#merge with Illig_data
Illig_data<- cbind(Illig_data, discovery_effect)
Illig_data<- cbind(Illig_data, replication_effect)
Illig_data<- cbind(Illig_data, all_effect)

rm(discovery_effect, replication_effect, all_effect)
###############

#NB! only 183 CpG sites are in the SABRE dataset
#which ones are missing?
missingcpgs <-  cpgs %in% rownames(SABRE_normalisedbetas)
missingcpgs<- subset(cpgs, missingcpgs =="FALSE")
missingcpgs
"cg03188382" "cg12513616" "cg16611234" "cg22649124"

#remove these CpGs from the index list
missingcpgs <-  cpgs %in% rownames(SABRE_normalisedbetas)
Illig_data <- subset(Illig_data, missingcpgs =="TRUE")

rm(missingcpgs, cpgs)


##########################################################################################################################
##calculate weights using effect size (mean diff in methylation in smokers vs non smokers) from Illig data
##########################################################################################################################
#find mean effect size per CpG (as methylation betas) is Illig_data$all_effect

#Find average effect for all CpG sites combined
Illig_data$abs_all_effect <- abs(Illig_data$all_effect)
overall_average_effect <- mean(Illig_data$abs_all_effect)

#Generate weights and merge with Illig_data
#weights= per CpG site effect size / average effect size for all CpGs measured
weights<- Illig_data$abs_all_effect/overall_average_effect

Illig_data$weights <- weights

rm(overall_average_effect, weights)
############################################################################################################################################################
#Split data into CPG sites that increase or decrease in smokers
############################################################################################################################################################
Illig_data_up <- subset(Illig_data, Illig_data$all_effect >=0)
Illig_data_down <- subset(Illig_data, Illig_data$all_effect <0)

############################################################################################################################################################
#subset SABRE data and order
############################################################################################################################################################

#SABRE_data_down
select <- rownames(SABRE_normalisedbetas) %in% Illig_data_down$cpgs
SABRE_normalisedbetas_down <- subset(SABRE_normalisedbetas, select =="TRUE")


#SABRE_data_up
select <- rownames(SABRE_normalisedbetas) %in% Illig_data_up$cpgs
SABRE_normalisedbetas_up <- subset(SABRE_normalisedbetas, select =="TRUE")

rm(select)

#sort Illig data by Cpg name
Illig_data_up<- Illig_data_up[order(Illig_data_up$cpgs),]
Illig_data_down<- Illig_data_down[order(Illig_data_down$cpgs),]

#sort SABRE data by Cpg name
SABRE_normalisedbetas_up <- SABRE_normalisedbetas_up[order(rownames(SABRE_normalisedbetas_up)),]
SABRE_normalisedbetas_down <- SABRE_normalisedbetas_down[order(rownames(SABRE_normalisedbetas_down)),]


head(rownames(SABRE_normalisedbetas_up))
head(rownames(SABRE_normalisedbetas_down))
head(Illig_data_up$cpgs)
head(Illig_data_down$cpgs)

############################################################################################################################################################
#Calculate diffs between SABRE beta values and the reference for each CpG site - ##UP###
############################################################################################################################################################

matrix_up<- matrix(nrow=nrow(Illig_data_up), ncol=ncol(SABRE_normalisedbetas_up))
for (i in 1:ncol(SABRE_normalisedbetas_up)){
  matrix_up[,i]<- (SABRE_normalisedbetas_up[,i])-(Illig_data_up$reference_never_median_beta_all)}
colnames(matrix_up)<- colnames(SABRE_normalisedbetas_up)
rownames(matrix_up)<- Illig_data_up$cpgs

############################################################################################################################################################
#Calculate scores - ##UP##
############################################################################################################################################################

##calculate scores for each individual in the dataset
scores_up<- as.numeric(rep(NA,ncol(SABRE_normalisedbetas_up)))
for (i in 1:ncol(SABRE_normalisedbetas_up)){
  scores_up[i]<-sum(matrix_up[,i]*Illig_data_up$weights)}

plot(samplepheno$smk_categoryv1, scores_up)

rm(Illig_data_up, SABRE_normalisedbetas_up, matrix_up)
############################################################################################################################################################
#Calculate diffs between SABRE beta values and the reference for each CpG site - ##DOWN###
############################################################################################################################################################

matrix_down<- matrix(nrow=nrow(Illig_data_down), ncol=ncol(SABRE_normalisedbetas_down))
for (i in 1:ncol(SABRE_normalisedbetas_down)){
  matrix_down[,i]<- (Illig_data_down$reference_never_median_beta_all)-(SABRE_normalisedbetas_down[,i])}
colnames(matrix_down)<- colnames(SABRE_normalisedbetas_down)
rownames(matrix_down)<- Illig_data_down$cpgs

############################################################################################################################################################
#Calculate scores - ##DOWN##
############################################################################################################################################################

##calculate scores for each individual in the dataset
scores_down<- as.numeric(rep(NA,ncol(SABRE_normalisedbetas_down)))
for (i in 1:ncol(SABRE_normalisedbetas_down)){
  scores_down[i]<-sum(matrix_down[,i]*Illig_data_down$weights)}

plot(samplepheno$smk_categoryv1, scores_down)

rm(Illig_data_down, SABRE_normalisedbetas_down, matrix_down)
############################################################################################################################################################
#combine scores
############################################################################################################################################################
scores_combined <- scores_up + scores_down
plot(samplepheno$smk_categoryv1, scores_combined)

rm(scores_up, scores_down,i)
